Ferran Vegas - arquitecto soluciones
Curso administrador Azure.

Curso de azure: https://virtualizadesdezero.com/

7/2/2022

Azure Active directory -> Autentica kerberos y autorizar.
Atenticar Recursos locales y los modernos ()

solo tengo una identidad, pero realmente tienes dos (active directory + azure AD)

service account -> es una identidad apartir de 2012.

Azure tenant -> es un AD de Azure - intancia de Azure (global admin -> permisos totales en el tenant, gestiona las usuario, etc.. no tiene coste y cambia a nivel de licencias que aplicas)
Azure subscription -> para crear recursos es la suscription. entorno de facturación, permite crear recursos

intune (endpoint manager) -> quieres gestionar todos mis dispositivos.
automatizacion y logs.
logs analitics servicio "pay as you go"


azure AD -> solucion identidad. diseñada para comunicaciones http y https.
Queries usados Rest API.

No hay gerarquica. es una estructura plana.

4 sabores de Active directory.
free, microsoft 365 apps, P1 , P2 (Premium)

seguridad moderna -> 
office 365 -> proteger informacion sin tener que meterte en los equipos.
con la P2 govierno identidades.

MIM -> Microsoft identidad Manager para la gestion reset usuarios, etc..

active directory on-prem y se sincronice en azure AD mediante connect.

asignar localización de usuarios.
ad connect (identity manager) provisionar identidades en la nube. software que te descargas.

Los grupos de seguridad no se pueden restaurar.

neuronaedgar@outlook.com
edg0000$8

https://github.com/MicrosoftLearning/AZ-104-MicrosoftAzureAdministrator.git

AZ-104-MicrosoftAzureAdministrator/Instructions/Labs/LAB_01-Manage_Azure_AD_Identities.md

14/02/2022
Gobierno
pay as you go -> controlar subscription.
residencia de la información por regiones.
Coste regiones -> 
Calidad de las comunicaciones.
Flexibilidad y capacidad de escalado.
Las IP estáticas son reservas de DHCP.
Las soluciones PaaS vas vinculadas a la region y dan un SLA.
SLA de Azure 99,95 una instancia.
Han sacado ahora balanceadores globales.
Cosmosdb bases de datos nosql.
Todas las regiones tienen una region pareada -> replicar la informacio en otro datacenter.
Lo que almaceno en azure es durable -> si hubiera un desastre habria una region replicada.

Generar una subscription para deplegar un servicio (intune, etc..)
- Enterprise agreement, se renegocia cada año. (Si dispones más de 25 servidores)
- Resellers -> CSP una empresa hacen de intermediario.
- Partner -> subscripcion o generan una solución tipo SaaS, PaaS, yo solo lo uso.
- Personal free account -> cuenta gratuita de 30 dias.

Tienes que convertir la subscrippcion a "pay as you go" para que te cobren

- free appservices (1h)
- Balanceadores en basics.

No todas las subscripciones tienen cost analisis.
Cost Management:
- cost analysis
- Cost alerts
- Budgets
- Advisor Recommendations.

Tag:
recursos classic -> estructura formato similar a AWS.
Resource Manager -> resource group 
etiqueta para costes. facturacion internas.
facturacion por grupo de recursos.
Tags para automatizar.
Autoshutdown ->
Automation account -> arrancar las maquinas a una hora concreta.
  
Ahorro costes:
reduccion de costes hay que modernizar la aplicaciones.
ventaja hibrida -> pago de la licencia con software asurance.
Reserva instancia 1 año 41% y 3 años 62%. La licencia se mantienen.

Para reducir los costes te debes transformar en un PaaS.
Politica de inmobilidad es una mala politica.

Management group son conjunto de subscripciones. Organizaciones logicas de susbcripciones.
Azure Policy "directivas" -> 
- politicas que bloquean 
- verificacion de cumplimiento y se ponen. 

initiative "iniciativas" -> conjunto de politicas es una agrupacion y se aplican, asignan a:
- management group
- recursos.
- etc..

permisos y roles -> 

Apartado de compliance

ASR -> replicar la maquina entre regiones. Es caro, es mas barato snapshot y lo mueves y lo atachas.

Es mas facil indicar los recursos que no quieres que se despliegue, pues indicar los que quieres puede  provocar que permites compute machine pero no las networks, etc...


Politica habitual acceso basado en roles.
role: owner - permiso para todo.
"global admin" esta en el tenant, solo para crear usuarios.

contributor -> todo lo del owner pero no puede hacer delagaciones, dar acceso a un recurso.
Reader -> pueden leer todo.

User access administrator -> puede asignar permisos pero no modificar. 
Siempre al menor permiso.

security Principal -> role definition, role asignment.

role en Azure -> objeto maquina no de dentro servidor.

Roles de:
Azure active directory -> usuarios, grupos, licencias, etc.. permisos aplicaciones. Scope es el tenant.
Azure RBAC de azure -> roles a subcripcion, recursos, manage group, etc..

autenticacion y autorizacion lo gestiona azure AD.

Global admin/User access admin solo hay uno y es dueño de la subcripcion.
User access Administrator -> es lo que le falta el contributor.

16/02/2022
herramienta de administracion.
Portal viejo "basic" 
Azure Resource Manager -> ARM capa de gestion. interface para comunicarnos con azure.
Microsoft crea portal nuevo para simplicar la gestión

te permite agrupar los recursos en grupos.
Log analitics -> Origen de logs. (Azure Monitor)
SIEM Azure sentinel -> 
Qradar IBM es top.
Siem debe ser capaz de recoger los logs. Leer de Log analitics y analizarla.

grupo recursos -> no se puede anidar y un recursos no pueden estar en 2 grupos de recursos diferentes.
Se pueden mover recursos de un grupo a otro (casi todos) pero no renombrar una vez creado.
Pueden tener recursos de multiples regiones.

plantilla ARM -> tener infraestructura como codigo.

Todos los recursos tienen un proveedor "Resource Provider"
Resource Manager Lock -> delete (no te permite borrar) y read-only (ni borrar ni cambiar configuracion)

 https://exam-files.com/Microsoft/AZ-104/
 
Resource Limits "quota"
Problema para soluciones para escalar -> "scale set" 
 
new-azresourceGroup -Name ppillo -location northeurope -> te crea un grupo de recursos.

Cloud shell necesita de "storage account"

get-azcontext
get-azsubscrition
set-azcontext -suscription "susciprcion" # para cambiar de suscription

Referencias comandos CLI
https://docs.microsoft.com/es-es/cli/azure/
Referencias comandos Powershell
https://docs.microsoft.com/es-es/powershell/azure/get-started-azureps?view=azps-7.2.0

Para instalar el modulo de powershell de Azure en tu equipo.
PS c:\xxxx > install-module AZ 
PS c:\xxxx > import-module az
PS c:\xxxx > connect-azaccount -TenantID "d527217bdegd7d17"
PS c:\xxxx > get-azcontext 

CBT Nuggets -> repositorio para dependencias.
Visual Studio Code

Para instalar el modulo de CLI de Azure en tu equipo
https://docs.microsoft.com/es-es/cli/azure/install-azure-cli-windows?tabs=azure-cli

Plantilla deploy.
https://azurecharts.com/templates

Para generar plantillas, cuando creas un recurso desde web puedes crear al finalizar una plantilla de la generada.
https://azure.microsoft.com/en-us/resources/templates/

21/02/2022 - networking

Virtual Network -> representacion logica de la network. 
n espacios de direcciones.
los dispositivos se conectan a subnets.
Azure toda las subredes están enrutadas entre si.
Se pierden 5 IP dentro del subnet en Azure. Primera y ultima, la 1 para montar gateway, y 2 y 3 para azure.
en vez 8 tienes 3
en vez de 16 vas a tener 11 IP's.
nsg -> seguridad
Virtual Network es a nivel de region.

10.3.1.0/29 -> red mas pequeña -> solo 5 dispositivos.

network watcher agent -> pruebas de conectividad.
Conection Trobleshoot -> 
las ip privadas son dinamicas. Las puedes fijar si haces reserva en un DHCP que no manejas.
Si se debe resdesplegar, etc.. que haga cambiar la mac de la tarjeta red tienes un problema que no podras tener esa IP nunca mas.
No podeis desplegar servicio DHCP en Azure.
Hay configuraciones y servicios que no puedes desplegar en Azure. PXC, ToIP, etc..

Basicas -> no te permite meterlas segun que recursos fijas.

Elementos accesibles a Internet.
SKU estandard para IP staticas segun servicios como VPN, aplication Gateway

NSG -> network Security Groups. especie de FW sin serlos. Permite limitar trafico que va a llegar a un recurso.
Se puede asociar a un subnet o tarjeta red.
Utiliza el FW de windows. Azure no regala el appliance.

Servicios expuestos a internet no se utiliza NSG. Se debe utilizar Azure Firewall.
NSG para traficos internos.

Reducir al maximo el numero de NSG a utilizar.

No mira la mas restrictivas, ni nada.. Mira ambas la de la subnet y la de la puerta de casa. 
No se suman los NSG... se aplican por cascadas.

No NSG en maquinas expuestas a internet.

Azure Firewall es un servicio caro para lo que hace. Firewall as a service - PaaS
Servicio que escala muy bien.

Estructura "Hub-Spoke" Network es una red en estrella.
red hub FW, VPN, etc..

Se debe meter en la Subnet especifica: AzureFirewallSubnet la sunet minima es /26 10.4.1.0/26 es la minima.

Regla de enrutado que haga pasar por el Firewall.

23/02/2022

Servicio DNS 
- Publico -> limitado en funcionalidades. 
- Privado -> zonas privadas, para resoluciones de mi infra interna en azure.

tenant "domainname.onmicrosoft.com"
custom domain -> miempresa.com
hay que verificar el dominio que sea tuyo.
Se debe generar una entrada específica en el DNS publicos que sirven la zona para validar que es tuyo.

Virtual network link -> si habilitas cuando arrancan las VM se registran automáticamente. Autoregistro con Active directory onprem.
Registros automáticos se realizan con dhcp, con reservas, pero No se realiza si la cambias a mano.

Comprobar comunicaciones mediante powershell:
Test-NetConnection 234.222.345.345 ip -Port 3389

siempre simplificar el numero de SNG a desplegar. 

No salen con la IP publica que te asignan. Sales con una IP de Azure.

IP forwarding -> para poder reenviar por la tarjeta de red.

Para comunicar "Virtual Network" se debe hacer peering y se enrutan por defecto.
Se puede realizar peering globales.
Se puede realizar en otro tenant o otra subscripción, etc..

La comunicacion es por la red de Azure, comunicaciones internas, mejor latencias, mas seguro que vpn, etc...
No son transitivos.
https://azure.microsoft.com/en-us/pricing/details/bandwidth/

Se debe hacer en ambos sentido si se emplea TCP.

Red de hub-spoke --> puedes enrutar los spoke en el vpn gateway del hub.

Service Chaining -> red de Hub y red de spoke con la infraestructura.
red hub como concentrador de comunicaciones.

puedes utilizar el gateway remoto que tienes a lado.

Amazon lo llaman "landing zone" una infra de Hub-Spoke es lo mas sencillo.

Subnet "GatewaySubnet" 10.10.1.0/28 o /27 es la recomendacion para un red de gateway.
Se debe llamar el segmento de red "GatewaySubnet" y no debes desplegar otros dispositivos en esa subnet o unicamente el vpn gateway o el express route.
Express Route es una MPLS.
VPN tienes latencias que te ofrece internet.
Express Route es un proveedor y te provisiona una conexion privada que te garantiza latencias mas baja y velocidad.


VirtualNetworkGateway --> un gateway VPN.
- site2site 
- Vnet-Vnet es lo mismos que los peering globales, mas caro y mas laatencia.
- Point2site (user VPN)

Local network gateway -> identificador del fw al que vamos a conectar para realizar la vpn. IP publica.
Guias publicadas de los principales fabricante (juniper, cisco, etc..) para conectar la vpn.

Políticas IPsec para donde enviar los paquetas.
Politica de routas, se puede emplear BGP 

El Maximo son 30 tuneles distintos S2S en cambio P2S hasta 5.000 users.
Las Maquinas Virtuales tienen 1GB

Solo se puede hacer resizing de la misma generacion.



 





 