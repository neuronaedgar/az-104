Ferran Vegas - arquitecto soluciones
Curso administrador Azure.
Libro: https://skillpipe.com/#/account/login
User: edgxx.yyyyyy.zzzres@gmail.com
Passwd: el de neuronaedgar@outlook.com

Azure:
neuronaedgar@outlook.com
E...$8

Curso de azure: https://virtualizadesdezero.com/

7/2/2022

Azure Active directory -> Autentica kerberos y autorizar.
Atenticar Recursos locales y los modernos ()

solo tengo una identidad, pero realmente tienes dos (active directory + azure AD)

service account -> es una identidad apartir de 2012.

Azure tenant -> es un AD de Azure - intancia de Azure (global admin -> permisos totales en el tenant, gestiona las usuario, etc.. no tiene coste y cambia a nivel de licencias que aplicas)
Azure subscription -> para crear recursos es la suscription. entorno de facturación, permite crear recursos

intune (endpoint manager) -> quieres gestionar todos mis dispositivos.
automatizacion y logs.
logs analitics servicio "pay as you go"


azure AD -> solucion identidad. diseñada para comunicaciones http y https.
Queries usados Rest API.

No hay gerarquica. es una estructura plana.

4 sabores de Active directory.
free, microsoft 365 apps, P1 , P2 (Premium)

seguridad moderna -> 
office 365 -> proteger informacion sin tener que meterte en los equipos.
con la P2 govierno identidades.

MIM -> Microsoft identidad Manager para la gestion reset usuarios, etc..

active directory on-prem y se sincronice en azure AD mediante connect.

asignar localización de usuarios.
ad connect (identity manager) provisionar identidades en la nube. software que te descargas.

Los grupos de seguridad no se pueden restaurar.

neuronaedgar@outlook.com
e......8

https://github.com/MicrosoftLearning/AZ-104-MicrosoftAzureAdministrator.git

AZ-104-MicrosoftAzureAdministrator/Instructions/Labs/LAB_01-Manage_Azure_AD_Identities.md

14/02/2022
Gobierno
pay as you go -> controlar subscription.
residencia de la información por regiones.
Coste regiones -> 
Calidad de las comunicaciones.
Flexibilidad y capacidad de escalado.
Las IP estáticas son reservas de DHCP.
Las soluciones PaaS vas vinculadas a la region y dan un SLA.
SLA de Azure 99,95 una instancia.
Han sacado ahora balanceadores globales.
Cosmosdb bases de datos nosql.
Todas las regiones tienen una region pareada -> replicar la informacio en otro datacenter.
Lo que almaceno en azure es durable -> si hubiera un desastre habria una region replicada.

Generar una subscription para deplegar un servicio (intune, etc..)
- Enterprise agreement, se renegocia cada año. (Si dispones más de 25 servidores)
- Resellers -> CSP una empresa hacen de intermediario.
- Partner -> subscripcion o generan una solución tipo SaaS, PaaS, yo solo lo uso.
- Personal free account -> cuenta gratuita de 30 dias.

Tienes que convertir la subscrippcion a "pay as you go" para que te cobren

- free appservices (1h)
- Balanceadores en basics.

No todas las subscripciones tienen cost analisis.
Cost Management:
- cost analysis
- Cost alerts
- Budgets
- Advisor Recommendations.

Tag:
recursos classic -> estructura formato similar a AWS.
Resource Manager -> resource group 
etiqueta para costes. facturacion internas.
facturacion por grupo de recursos.
Tags para automatizar.
Autoshutdown ->
Automation account -> arrancar las maquinas a una hora concreta.
  
Ahorro costes:
reduccion de costes hay que modernizar la aplicaciones.
ventaja hibrida -> pago de la licencia con software asurance.
Reserva instancia 1 año 41% y 3 años 62%. La licencia se mantienen.

Para reducir los costes te debes transformar en un PaaS.
Politica de inmobilidad es una mala politica.

Management group son conjunto de subscripciones. Organizaciones logicas de susbcripciones.
Azure Policy "directivas" -> 
- politicas que bloquean 
- verificacion de cumplimiento y se ponen. 

initiative "iniciativas" -> conjunto de politicas es una agrupacion y se aplican, asignan a:
- management group
- recursos.
- etc..

permisos y roles -> 

Apartado de compliance

ASR -> replicar la maquina entre regiones. Es caro, es mas barato snapshot y lo mueves y lo atachas.

Es mas facil indicar los recursos que no quieres que se despliegue, pues indicar los que quieres puede  provocar que permites compute machine pero no las networks, etc...


Politica habitual acceso basado en roles.
role: owner - permiso para todo.
"global admin" esta en el tenant, solo para crear usuarios.

contributor -> todo lo del owner pero no puede hacer delagaciones, dar acceso a un recurso.
Reader -> pueden leer todo.

User access administrator -> puede asignar permisos pero no modificar. 
Siempre al menor permiso.

security Principal -> role definition, role asignment.

role en Azure -> objeto maquina no de dentro servidor.

Roles de:
Azure active directory -> usuarios, grupos, licencias, etc.. permisos aplicaciones. Scope es el tenant.
Azure RBAC de azure -> roles a subcripcion, recursos, manage group, etc..

autenticacion y autorizacion lo gestiona azure AD.

Global admin/User access admin solo hay uno y es dueño de la subcripcion.
User access Administrator -> es lo que le falta el contributor.

16/02/2022
herramienta de administracion.
Portal viejo "basic" 
Azure Resource Manager -> ARM capa de gestion. interface para comunicarnos con azure.
Microsoft crea portal nuevo para simplicar la gestión

te permite agrupar los recursos en grupos.
Log analitics -> Origen de logs. (Azure Monitor)
SIEM Azure sentinel -> 
Qradar IBM es top.
Siem debe ser capaz de recoger los logs. Leer de Log analitics y analizarla.

grupo recursos -> no se puede anidar y un recursos no pueden estar en 2 grupos de recursos diferentes.
Se pueden mover recursos de un grupo a otro (casi todos) pero no renombrar una vez creado.
Pueden tener recursos de multiples regiones.

plantilla ARM -> tener infraestructura como codigo.

Todos los recursos tienen un proveedor "Resource Provider"
Resource Manager Lock -> delete (no te permite borrar) y read-only (ni borrar ni cambiar configuracion)

 https://exam-files.com/Microsoft/AZ-104/
 
Resource Limits "quota"
Problema para soluciones para escalar -> "scale set" 
 
new-azresourceGroup -Name ppillo -location northeurope -> te crea un grupo de recursos.

Cloud shell necesita de "storage account"

get-azcontext
get-azsubscrition
set-azcontext -suscription "susciprcion" # para cambiar de suscription

Referencias comandos CLI
https://docs.microsoft.com/es-es/cli/azure/
Referencias comandos Powershell
https://docs.microsoft.com/es-es/powershell/azure/get-started-azureps?view=azps-7.2.0

Para instalar el modulo de powershell de Azure en tu equipo.
PS c:\xxxx > install-module AZ 
PS c:\xxxx > import-module az
PS c:\xxxx > connect-azaccount -TenantID "d527217bdegd7d17"
PS c:\xxxx > get-azcontext 

CBT Nuggets -> repositorio para dependencias.
Visual Studio Code

Para instalar el modulo de CLI de Azure en tu equipo
https://docs.microsoft.com/es-es/cli/azure/install-azure-cli-windows?tabs=azure-cli

Plantilla deploy.
https://azurecharts.com/templates

Para generar plantillas, cuando creas un recurso desde web puedes crear al finalizar una plantilla de la generada.
https://azure.microsoft.com/en-us/resources/templates/

21/02/2022 - networking

Virtual Network -> representacion logica de la network. 
n espacios de direcciones.
los dispositivos se conectan a subnets.
Azure toda las subredes están enrutadas entre si.
Se pierden 5 IP dentro del subnet en Azure. Primera y ultima, la 1 para montar gateway, y 2 y 3 para azure.
en vez 8 tienes 3
en vez de 16 vas a tener 11 IP's.
nsg -> seguridad
Virtual Network es a nivel de region.

10.3.1.0/29 -> red mas pequeña -> solo 5 dispositivos.

network watcher agent -> pruebas de conectividad.
Conection Trobleshoot -> 
las ip privadas son dinamicas. Las puedes fijar si haces reserva en un DHCP que no manejas.
Si se debe resdesplegar, etc.. que haga cambiar la mac de la tarjeta red tienes un problema que no podras tener esa IP nunca mas.
No podeis desplegar servicio DHCP en Azure.
Hay configuraciones y servicios que no puedes desplegar en Azure. PXC, ToIP, etc..

Basicas -> no te permite meterlas segun que recursos fijas.

Elementos accesibles a Internet.
SKU estandard para IP staticas segun servicios como VPN, aplication Gateway

NSG -> network Security Groups. especie de FW sin serlos. Permite limitar trafico que va a llegar a un recurso.
Se puede asociar a un subnet o tarjeta red.
Utiliza el FW de windows. Azure no regala el appliance.

Servicios expuestos a internet no se utiliza NSG. Se debe utilizar Azure Firewall.
NSG para traficos internos.

Reducir al maximo el numero de NSG a utilizar.

No mira la mas restrictivas, ni nada.. Mira ambas la de la subnet y la de la puerta de casa. 
No se suman los NSG... se aplican por cascadas.

No NSG en maquinas expuestas a internet.

Azure Firewall es un servicio caro para lo que hace. Firewall as a service - PaaS
Servicio que escala muy bien.

Estructura "Hub-Spoke" Network es una red en estrella.
red hub FW, VPN, etc..

Se debe meter en la Subnet especifica: AzureFirewallSubnet la sunet minima es /26 10.4.1.0/26 es la minima.

Regla de enrutado que haga pasar por el Firewall.

23/02/2022

Servicio DNS 
- Publico -> limitado en funcionalidades. 
- Privado -> zonas privadas, para resoluciones de mi infra interna en azure.

tenant "domainname.onmicrosoft.com"
custom domain -> miempresa.com
hay que verificar el dominio que sea tuyo.
Se debe generar una entrada específica en el DNS publicos que sirven la zona para validar que es tuyo.

Virtual network link -> si habilitas cuando arrancan las VM se registran automáticamente. Autoregistro con Active directory onprem.
Registros automáticos se realizan con dhcp, con reservas, pero No se realiza si la cambias a mano.

Comprobar comunicaciones mediante powershell:
Test-NetConnection 234.222.345.345 ip -Port 3389

siempre simplificar el numero de SNG a desplegar. 

No salen con la IP publica que te asignan. Sales con una IP de Azure.

IP forwarding -> para poder reenviar por la tarjeta de red.

Para comunicar "Virtual Network" se debe hacer peering y se enrutan por defecto.
Se puede realizar peering globales.
Se puede realizar en otro tenant o otra subscripción, etc..

La comunicacion es por la red de Azure, comunicaciones internas, mejor latencias, mas seguro que vpn, etc...
No son transitivos.
https://azure.microsoft.com/en-us/pricing/details/bandwidth/

Se debe hacer en ambos sentido si se emplea TCP.

Red de hub-spoke --> puedes enrutar los spoke en el vpn gateway del hub.

Service Chaining -> red de Hub y red de spoke con la infraestructura.
red hub como concentrador de comunicaciones.

puedes utilizar el gateway remoto que tienes a lado.

Amazon lo llaman "landing zone" una infra de Hub-Spoke es lo mas sencillo.

Subnet "GatewaySubnet" 10.10.1.0/28 o /27 es la recomendacion para un red de gateway.
Se debe llamar el segmento de red "GatewaySubnet" y no debes desplegar otros dispositivos en esa subnet o unicamente el vpn gateway o el express route.
Express Route es una MPLS.
VPN tienes latencias que te ofrece internet.
Express Route es un proveedor y te provisiona una conexion privada que te garantiza latencias mas baja y velocidad.


VirtualNetworkGateway --> un gateway VPN.
- site2site 
- Vnet-Vnet es lo mismos que los peering globales, mas caro y mas laatencia.
- Point2site (user VPN)

Local network gateway -> identificador del fw al que vamos a conectar para realizar la vpn. IP publica.
Guias publicadas de los principales fabricante (juniper, cisco, etc..) para conectar la vpn.

Políticas IPsec para donde enviar los paquetas.
Politica de routas, se puede emplear BGP 

El Maximo son 30 tuneles distintos S2S en cambio P2S hasta 5.000 users.
Las Maquinas Virtuales tienen 1GB

Solo se puede hacer resizing de la misma generacion.

28/02/2022
Conectividad entre sitios

es azure quien levanta la VPN.
si se quiere hacer al reves se puede.
hibridar nuestra plataforma implica dependencias y debemos extender y que esten disponibles.

Baratas: GW Activo + GW Pasivo <---> onPrem VPN (Local network gateway)
Local network gateway es un identificador, no tiene computacion.

https://docs.microsoft.com/en-us/azure/vpn-gateway/vpn-gateway-about-vpn-devices

ExpressRoute -> Pago microsoft, + trafico, + pago ISP las comunicaciones.
latencias 20msg vpn's
ExpressRoute MPLS (punto a punto) a 10msg

Nos garantiza una tasa de trafico
Permite acceder a office365, CRM, etc..

capacidad layer3 con redundancia.
Se hacen los expressRoute lo mas cerca de ti para no pagar de más.
Con express route tambien debes definir los subred que se tienen abajo "onprem"

ExpresRoute + vpn 
Servicio estaria funcionando pero habría degradacion en caso de caida expressroute.


Ferran recomienda siempre que seas una empresa mediana emplear una expressroute.

Virtual Wan (aparecen hace un año)
Una consola que nos permite gestionar todos nuestros elementos.

Listar regiones: 
(Get-AzLocation).Location
Noth Europe
West Europe

Probar conexiones:
Desde Powershell:
Test-NetConnection -ComputerName 10.51.0.4 -Port 3389 -InformationLevel 'Detailed'

System Route: rutas de azure.
Rutas dentro subred.
Rutas de la VM que estan en diferentes subnets dentro virtual network.
La ruta por defecto para acceder a la intenet.
Las VPN se enrutan de modo automática.
Definir el espacio de ruta de on-prem gracias a la definición del Local network gateway.
Los Peerings.
y puedes gestionar y definir
UDR User Defined Routes -> las definicion de las rutas que se define.
NVA -> Network Virtual Appliance.
Las UDR sobre escriben a las que hayan en el sistema.

Las UDR van asociadas a las subnets. Se aplican a las subnets. Sino se aplican utilizan las de por defecto de sistema.

Hub-Spoke
se necesita un apliance para forwarding de trafico.
no se puede reenviar trafico desde spoke a spoke directamente.

Storage account -> servicio paas que se accede atraves de internet.
Service Endpoints -> bloquear acceso a traves de internet pero permites acceso desde una virtual network.
Estoy accesiendo a esos servicios a traves de servicios de azure.
Ahorro costes, por transferencia de datos. Es estupido sacarlo a internet para meterlo en azure. No hay coste de trafico si se emplea un service endpoint.

storage account -> almacenamiento de objetos.
securizar -> all network implica publico.
Proteger servicio -> 

En Virtual Network:
Service Endpoints -> keyvault, sql, etc... para permitir acceder al servicio desde Virtual Network.

Private Link -> Relay acceso a servicios. Todas las comunicaciones son internas. Solo elementos internos de azure pueden llegar. A traves de vpn o express route puedes emplear un private link.

Load Balancer -> Nivel 4 y Permite distribuir la carga entrante ediferentes backends.
Son protocolos round robin, es capaz de hacer pruebas de salud y elimina backends no correctos.
health probe

Load balancer hace los Nat de las comunicaciones, la respuesta la devuelve el balanceador, no los host.
capa 4 de transporte. No es SSL.

Balanceador es mas barato que aplication gateway (para hacer ssl)
Frontdoor es el frontal para SSL.
La solución antigua era incausula.
No se puede confundir balanceo con alta disponibilidad.
allwayson -> un master.
Balanceos -> servicio stateless. Las sesiones no pueden meter datos en el backend.

SKU's de balanceador -> SKU no se puede modificar.
Balanceador basic es gratis -> no vale para nada. (solo VM y scale set)
Balanceador standard -> es el de producción.
Solo es capaz balancear misma region.
El balanceador global -> puede balanceador entre regiones (hay que validar)

Backend pools -> elementos que hacen cosas.
reglas de balanceo -> 

Seguridad:
https://cpl.thalesgroup.com/es/encryption/hardware-security-modules/network-hsms

Balanceadores F5 pueden ver sesiones, cpu, memoria en las maquinas.

Azure Application Gateway -> Es un balanceador trabaja en capa 7, capacidades extras pero solo trafico web (http, https)

Listener tiene una reglas de balanceo.
VM , scale set, webapp, etc.. cualquier IP publica y FQDN.

Diferentes politicas de enrutado.
Proteger ataque sql injection -> mediante un WAF.
metodo enrutado:
- Path-Base: Con diferente path "funcion de path". contoso.com/video contoso.com/images Diferentes backend con diferentes recursos.
- Multi-Site: contoso.com y fabrikam.com 

En el listener se puede añadir un WAF.

DDOS -> Azure tiene uno por defecto.
Primero FW y luego Aplication Gateway.

Para enrutar los spokes se debe tener una appliance o un rras.
En la red de hub no debe haber maquinas que no realicen tareas de red.


Solo puedo balancear VM dentro de una Virtual Network. No puedo ver de otras VN.

Las VM no tienen IP publicas para trabajar con ellas, es el balanceador quien la dispone y se la asigna a sus backends.

WAF -> OWASP top 10.

Azure Storage.
- Discos 
- Bases de datos (SQL y cosmosdb)

Sharepoint online para almacenar ficheros. "mas caro pero mas eficiente"
samba para almacenar elementos stateful.
Storage account:
Durable -> info no se pierde, pero no quiere decir que este disponible.
Seguro -> se puede forzar que sea cifrada. https o samba 3.0. En transito y en reposo siempre esta cifrado.
El disco esta almacenado siempre en una storage account. en reposo esta cifrado pero la info del disco no lo está.
El disco por defecto no lo está, el vhd no esta cifrado.
- Bitlocket
- truecrypt

scalable -> no hay posibilidad de limitar.
managed -> Es gestionado, cambia de disco.
accesible -> desde cualquier sitio.

Que datos:
storage para VM -> Solo VHD. no VHDX no entiende y puede no poder levantarlo. hay windows 2012 corriendo todavia. 
Datos estructurados -> una tabla.
Datos no estructurados -> cualquier dato.
Mensajes. desacoplar servicios. 
- service bash
- queues

diferencias entre Premium y standard.
standard prima el almacenamiento -> puedes replicar contra otras regiones.
Premium prima el rendimiento y no es capaz de hacer replicaciones contra otras regiones solo contra zonas misma region.

Azure containers -> caja donde meto blobs (ficheros)
sharepoint almacenar ficheros ofimáticos.
almacenamiento en objeto -> sobre database.

metadato en la base de datos y ficheros filesystem.
Azure files -> share file mediante Samba 3.0. sacar info de los servidores. gestor de permisos no es lo mismo. No hay herramienta de auditoria. La gente pasa a sharepoint.

Azure tables -> base de datos no relacional. muy económica. NoSQL
Azure Queues -> desacoplar microservicios. algo sencillo. no garantiza orden entrega, dos elementos podría leer mismo elemento.

Servicebash -> garantiza entrega, FIFO, solo se procesa una vez. Transacciones de ventas o bancarias.
Se garantiza las transacciones.

07/03/2022
Durabilidad es pq Azure replica la info.
storage v2 -> es todo lo más. Se puededn montar todo los servicios y todas las capacidades de replicacion y los dos modelos standard y premium.

Microsoft piensa -> disco standard no quiere gatarse dinero y lo que le prima es la capacidad no las  prestaciones, por lo que permite replicacion local o regional.
Premium quiere performance -> penalizacion de replicacion datos

replicaciones sincrona -> penaliza performance.
asincrona -> la consistencia de los datos puede no ser coherente.

Todas las storage account estan encriptadas en rest mediante SSE.
LRS -> redundancia local, tres copias de mis datos dentro de mi region y en una unica zona.
ZRS -> redundancia zonal pero empleo las 3 zonas para replicacion.
GRS -> Redundancia regional. se realiza una copia en una region fuera pero no tengo acceso a ella ni a que region replicar.
La georeplicada, 3 copias en destino y 3 locales en una zona.
RA-GRS -> solo lectura a la region remota. Replicacion es de un solo sentido.
GZRS -> 3 copias distribuidas en las 3 zonas y 3 copias en region destina.
RA-GZRS -> lo mismo pero con opcion de lectura.

Siempre es la region pareda, no puedes elegir la region de sincronización.

Proteger los endpoints -> service endpoints para asegurar los endpoints.
la virtual network debe estar en la misma zona que la storage account.

Azure emplea su propia solución de hiperconvergencia como la de nutanix.
Blobs:
- son objetos.
almacenamiento basado en objetos.
los sistemas operativos estan basados en almacenamiento mediante sectores.

Almacenar un backup en una storage account.
Azure backup -> bakea en un vault, solo mola si tienes windows, no una maquina linux. (ni lo ha hecho ni lo hará nunca)

En una storage account se puede cifrar por lo que no es correcto realizar backups.
archivado -> durante años.

cuentas genericas igual los accesos publicos.
una tonteria que pueda leer puedes generar problema de seguridad.

delegar el acceso a la aplicación.
ASA -> shared signal signature.
acceso temporal de 2h, le doy acceso al usuario un tiempo y desacoplo la aplicacion.
Si le das acceso a la aplicación, si son ficheros grandes cargo la aplicación.

Si tienes el defender -> te explica si tienes una aplicacion mal desarrollada con vulnerabilidad. sql injection, etc..
WAF -> los CVE's nuevos los puedes integrar.

El permisos solo se vincula al fichero.

Access Tiers: Performance que tiene ese objeto.
- Hot -> Miles de peticiones
- Cool -> puedes editar.
- Archive -> para recuperarlo puede tarda 24h. Hay un rehidratado para agilizar pero sin SLA. 
ciclo de vida a nivel container de mis ficheros -> imagenes en cool pues no se requiere rendimiento.

Blob type: upload blobs

Block blob -> lo hace bien.

append blob -> objeto añado info al final.  logica


Storage Security:
- Storage Service Encryption.
- Azure AD y RBAC para autenticar.
- Client-side para encriptar en transito. SMB 3.0 cliente de Linux ya lo permite.
- Azure disk encryption -> para encriptarlo fuera del storage account. bitlocket win y mcryto para linux.
- Share Acess Signatures, SAS nadie ha pensado como gestionarlas.
- Shared key. Las claves no se comparten con nadie.
- acceso anonymous -> un error.

SAS -> elemento permite delegar permisos. IP's, tiempo, tipo RA/RO, etc..

Microsoft Azure storage explorer:

estoy vendido pues no se que se realiza o que se hace.
Puede revocar cambiando la clave con la que cifras.
Eso afecta a todos los sas que has emitido.

si te vas a container te permite montar un access policy que es parecido a un SAS
Maximo 5 access policy en un container
mismo problema pero esta vez puedes borrar la la access policy en vez de borrar la key que implica afecta a todas las SAS.

no tienes estadisticas en Azure.

Storage Service Encryption -> claves microsoft o las mias propias.
almacenadas en un Key Vault o almcenada en on prem en un HSM.

Best practices:

Servicio de files -> servicio samba para mapeo de una unidad a un sistema operativo.
migrar mi servidores de ficheros a la nuve.
File server almacenan ofimática -> por lo que es mejor emplear sharepoint online.

Azure files esta pensado para aplicaciones.
Para aplicar acl's hay un trabajo intenso, por eso no es conveniente emplear Azure file para file server.

Se aplican quotas.

se puede hacer backup con azure backup y hacer un snapshot.

No se hacen snapshot automáticos. Si se emplea azure backup no tiene sentido utilizar snapshots.

Azure file Sync -> replico ficheros. 
Es similar a distributing file system para replicar servicio de ficheros.

storage Sync Services.

storage Explorer -> herramienta para administrar storage account.

Dos servicios: Importacion y Exportacion.

Servicio Databox -> es el snowball de AWS.

Az copy -> herramienta sencilla que equivale a un robocoy, las ventajas que un extremo puede ser un storage account

https://docs.microsoft.com/en-us/azure/storage/common/storage-ref-azcopy-copy

Azure Virtual Machine:
menos carga administrativa pero menos control.
IaaS -> Me tengo que adaptar a los ciclos de vida de azure y no dejará 2008 alguna vez. este es el problema de moverte a estas soluciones.
Migro de on-prem a IaaS, lo que yo se.

Si no se cumplen SLA, te dan creditos de azure.

SQL como servicio es mas barato que como IaaS.
No gestiono sistema operativo ni la base de datos.
Mis aplicaciones deben actualizarse y seguir el mismo ciclo de vida que azure.
Puedes pagar 60% y hacerlo ejecutar en una IaaS.

"Esto funciona, no lo tocamos" -> hay que eliminar este concepto, adaptar a los tiempos.
exchange online, sharepoints.
google apps -> Software as service. 
OWA -> 

09/03/2022

Sobredimensionamiento de VM cuando la capacidad es limitada.
En el cloud no se debe reservar computacion.
dimensiono 60% CPU sostenido y 70% de memoria. 
Si me quedo corto escalado vertical.
Paris es mas Barato que Marsella, y hay localizaciones que no disponen de todos los servicios.
Si apago computacion dejo de pagar cpu y ram pero pago el storage.

En cuanto a las versiones, se debería seleccionar la ultima. Siempre ultimas versiones Windows 2022.
Siempre funcionalidad y luego costes.
Has de validar que todas las funcionalidades que necesitas esté en la región.

CDN: akamai, verizon y cdn standard de microsoft.

Administracion publica certifico azure.

Si se puede ampliar los discos del storage de las VM.

Series A: 8 cpu de hace 10 años...
Serie B: pare entornos preproduccion
Serie D: maquinas mediocres, generalistas y minima para entorno produccion.
Dc: proteccion de datos.

 
 Disco c:\ sistema operativo.
 Disco d:\ temporal  disco que borran. descargar software, etc..
 Disco Datos f:\
 cada maquina tiene un tipo de disco a añadir. 
 Discos gestionados -> gestiona microsoft.
 Disco no gestionado -> gestiona el usuario.

¿Quien tiene el problema ?

Los disco se alamacenan/están en los storage account.
storage account es nuestra controladora. 
cual es el limite --> 25 discos por storage account.
Es recomendable tener discos gestionados para que los gestione microsoft.
Discos standard hdd o sdd , no hay SLA.
Disco premium -> hay un SLA 99,9 
Disco Ultra

No se puede acceder a la maquina hasta que hay una imagen.
Las maquines tienen un agente que permiten apagar VM, NSG, etc..

Microsoft indica que utilicemos las imagenes que tienen en azure, para que dispongas agentes.

Los windowseros no son informáticos de elite.
Partiendo que no te debes conectar a las maquinas, no deben tener ip publicas.
Bastion te permite acceder a tus maquinas sin necesidad de tener IP publicas.
Encapsula RDP con 443
Es una VPN SSL

Ciberacts

Para bastion debes crear una virtual network donde este las maquinas a saltar.
necesita una subnet para él. Debe nombrarse AzurebastionSubnet y debe tener minimo una subnet /26

Identity -> usar identidades para recursos.
Puedes asignar una identidad para poder acceder al SQL, etc... Managed Identity

Importante zona horaria.
Extensiones:
Network watch
Custom script extensions -> ejecutar script durante el despliegue de la VM.
es equivalente a "runonce"

No se dispone de una consola para interactuar con las maquinas.
WinRM -> para administrar los servidores en azure. No emplear el RDP a las maquinas.

La problematica es que hay muchas distribuciones y muchos sabores de linux.

Avavility:
Mantenimiento y caida.
En on-prem evitamos las actualizaciones.
Manteniiento reinicios, actualizacion, etc..
Planificados -> cada Martes de inicio de mes cuando salen los parches.
Live migration -> lo pasa a otro hipervisor.

Unexpected Downtime -> caida por hardware.
 
SLA calculator -> 
SLA se calcula mensualmente -> 43 minutos cuando tienes discos premium 99,9
Los sistemas se actualizan cuando tocan...
Microsoft da solución/herramientas para alta disponibilidad, pero no por defecto.

Estrategias -> Availability Sets 

Fauld Domain -> hasta 3
Update Domain -> hasta 20

FaultDomain es un rack (cabina, corriente, etc ..independiente) dentro mismo Datacenter.
UpdateDomain -> grupo de actualizacion. las actualizaciones y lo reinicion no se solapan en los UD.

deployo los Webserver primero y azure me los va balanceando en los diferentes FD y UD y luego deployo los dos SQL.
Hay que meter un LB antes de los Webservers y configurar alwayson cluster para balancear SQL.
Se debe separar por funcionalidad en avavility sets.

El mundo de las ideas es muy limitado, hay arquitecturas de referencias.

Solo se pueden asociar las maquinas en un AS durante la creación, no te permite posteriormente, lo tienes que calzartelas y volverlas a crear.

SLA 99,95 por lo que pasas a 21 minutos 54 sg.

SLA de la solución queda por debajo del SLA mas bajo de todos los servicios.
los SLA se multiplican.

Availability Zone -> multiples datacenters independientes.
SLA 99,99%
y luego emplea FD y UD de forma interna, no debes preocuparte.

https://azure.microsoft.com/es-es/support/legal/sla/summary/
 
Se puede crear con un automation de forma automatizada el escalado vertical, pero hay un reinicio.

Stateless:
No puedo almacenar informacion en esa maquina.
hacer un scale set en onprem no tiene ningun sentido porque conozco el tamaño máximo de mi hardware.
Adaptar a la demanda al menor precio.
condicionantes especificos -> "stateless"

Scale Set -> puedes poner ip flotantes para conectarte a una maquina concreta dentro del scale set.
desde 0 hasta 1000 instancias pueden escalar.

Si son imagenes customizadas hasta 100.

Spot instance -> precio maximo por la VM.
   
utilizar discos gestionados.
autoescalados son reglas de monitorización.

umbrales de CPU
Escalo cuando superior a 80% sostenido 5 minutos.
Reduzco cuando 60% sostenido 5 minutos.

escalado funcionan monitorizando la CPU.

CPU > 80% (average 10 minutos de que esten al 80%) -> 10mi -> Cooldown 5 min.(estabilizacion)

1 maquina -> x5 Cuanto tado en adaptarme a una crecida de este tipo -> 55 minutos.

a los 10 minutos 2VM a los 5 minutos (cold down) -> 3VM --> 5 min --> 10 min -> 4MV 5 + 10 5VM => 55 min
Crecimiento sostenidos -> lineales.

cooldown -> tiempo estabilización

escalado programaticamente.
añades la capa de prevision a la capa de crecimiento.

21/03/2022

scale set -> autoescalado horizontal.
Lo normal es generar maquinas generadas por nosotros.

Azure files -> para storage persistente para todas las VM del scale set.

100 instancias si generas tu las imagenes a desplegar.
Tienes que tener IP libres para escalar en tu subnet
Solo puedes monitorizar contadores de VM. -> CPU,RAM -> basado en metricas.

Basado en metricas cuando son crecimientos lineales.
en crecimientos exponenciales, picos basado en numeros de instancias "programado"
Puedes tener mas de una metrica y debes crear las 2 reglas, las de crecer y la de decreder.

Las extensiones son agentes que puedes desplegar durante el despliegue o cuando estan ejecutandose.

Custom Script extension -> permita lanzar un script que haga lo que tenga que hacer. Se ejecuta como usuario system.  
hay una liminitacion de 90 minutos para que se ejecute. si pasa da un error. Es el equivalente de runonce, solo se ejecuta una vez.

No poner password en los script, se emplea keyvault

DSC -> Desired State Configuration. Funcion interesante que cada pasada fuerza esa configuración. cumple un baseline.+

Automation Account -> cosas interesantes para admiistrar VM.
inventario
Gestion de cambios de VM.
SDC para control de aplicaciones, etc..

Module 9: Soluciones Serverless
App Services Plans: (cualquier aplicacion que habla http)

Nos asignan una capacidad de memoria y cpu y nos definen precio.
Se puede compartir con diferentes aplicaciones
Se define region y numero instancias y el tamaño y el precio.
Servidor ISS o Apache y se ejecuta diferentes aplicaciones.
solo me tengo que ocupar de picar el codigo.

Tier free solo 2 horas de ejecución.
hasta 10 aplicaciones diferentes.
No deployment slot y sin scalado.

ejecuta la ultima version de windows disponible, no te permite cambiar de S.O.
tengo contadores interesantes para el scaling.
Los frontales no van a saturar por CPU pues solo envia peticiones al backend y es quien utiliza la cpu.

100 acu Azure compute unit -> 1 vCPU
Familia A, cliente rata.

Los ASE son los app services Plan del tipo isolate.

http queue -> metrica buena para escalar las app Services.

Siempre vas a poner aplication gateway por delante.

.NET, node, php, java, python, html5 y tambien puede ejecutar contenedores.
Las aplicaciones que no corren bien en un app services, se pueden meter en un contenedor y hacerlo funcionar en un app services

app services están certificados. Podeis trabajar con PCI-dss compliance, 27001, etc..

Application Insigths para monitorizacion de servidores windows.

Bitnami -> 
incapsula WAF cañero.

23/03/2022

Deployments slots a partir de standard.

deployment slot en prod y tengo un segundo deployment slot en des.
app service plan -> es el tipo de maquina. (standard, etc..

Sobre linux la monitorizacio no esta activada.

Si creas un deployment slot mas,  te abre otro app services para que defines otra version, otra aplicacion, etc...
Tienes dos aplicaciones en un mismo app services.

Canari es distribuir trafico en tanto % a preproducción.

El Swap funciona bien siempre que no empleas cadenas de conexion, custom domain name (certificados), backup,  etc..
Hay un apartado configuracion para emplear variables, etc..

Hay que construir la aplicacion pensando en utilizar app service, para emplear librerias propias para emplear configuraciones como variables.

Si quieres que tu aplicacion solo sea acceso interno, se debe deployar mediante un ASE un app service isolate.

Application insights -> monitorizar las aplicaciones.

containers Services.

Container instances -> plataforma PaaS para ejecutar contenedores.

container Group -> seria un docker compose.

Container Registry -> registry de contenedores.

AKS
Azure monitor es quien monitoriza AKS
kubelet -> agente que se encarga de hablar con el master.

cordon & drain -> upgrade de AKS.

AKS -> puede integrarse con Azure AD

Virtual Kubelet -> te permite extender la plataforma a multiples plataformas, container instances, Azure Batch, k8s on-prem.

Azure Front Door te permite poner pesos y te hace redireccionamiento de forma automática en caso de fallo de un entorno k8s.

28/03/2022
Azure backup -> herramienta de backup es buena para Windows. Hacen copias a un vault.
MARS
Todas las herramientas convo, veritas, etc.. todas hacen contra storage a account.
Opciones almacenamiento -> vault o a un disco (azure backup server).
trafico ilimitado
data encryption en reposo y en trafico.
Hacen copia 3 aplicaciones: SQL, Exchage, sharepoint (office 365)
Retenciones a largo plazo (hasta 5 años)

- Azure Fileshare
Los backups de los storage account solo se puede copiar fileshare, no de un container.

- Contra un un server (tanto Azure como desde on-prem)
te descargas un agente -> Microsoft Azure Recovery Services Agent.
Registrar el agente:
- debes descargar la credenciales del vault.
Maximo de 3 backups al dia.

Para un par de servidores, tiene sentido pero cuando hay miles no tiene sentido.

Data Protection:
- Snapshot
- azure backup -> copia ficheros, no hace falta pagar licencia, no copia cinta 
DPM -> Pagar Licencia y puedes copiar cinta.
- Azure Site Recovery - > ASR permite replicar maquinas a region remota -> site recovery de vmware.

Hay en el marketplace todas las soluciones. Veem, Acronis, backupexes, etc..

Instance Recovery - snapshot

Solo puede backear en la misma region.
Recovery Services ->

Azure Backup Server (MABS) 

Soft Delete -> retained for 14 dias -> delete 14 dias.

Azure Site Recovery -> Migraciones a azure, entorno activo - pasivo
Azure migrate -> servicio que han creado microsoft para migrar.

RPO -> 0 gracias a que lo hace mediante un cache de datos.

montar xxxx step-step -> documentacion microsoft.

Traffic Manager -> redirige las peticiones a una region u otra.

Plantilla funciona NorthEuropa (con la subcripcion free)
Standard_D2ads_v5 

az aks create --resource-group myResourceGroup --name enaAKSCluster --node-count 1 --enable-addons monitoring --generate-ssh-keys --nodepool-name enapool --node-vm-size Standard_D2ads_v5

30/03/2022
Azure monitor
problematica es la que tiene cualquier tipo de servicio que tiene una plataforma.
menos control tienes.
Deciden cual son los contadores en funcion de la topologia que quieres monitorizar.
scale set -> metrica y hace una respuesta automática en funcion de los contadores.
problematica logs es grande es dificil de gestionar.
Solucion muy extendida "splunk" -> recoge logs y analiza.
Log analitics de microsoft hace lo mismo que splunk.
Lenguaje Kusto para analizar los datos.
https://docs.microsoft.com/es-es/azure/data-explorer/kusto/query/
Alertas con acciones automáticas -> autoremediación.

Puedo recoge metricas o Logs.
insights -> parte de sacar conclusiones.

Azure Alerts
No se emplea. Se suele emplear las alertas del sistema de ticketing.

reglas y accion groups 

Toda la telemetria se envia a un workspace -> Log analitics workspaces
cada workspace te ofrece: reginalizacion, scope, etc..
datos de telemetrias y lo envias en logs analitics

SCOM para recoger telemetria y luego para a Logs analitics

Network watcher es un servicio regional.
Te pinta topologia.
Pinta la red del resource group

IP flow verify -> ver si esta permitida una conexion
NSG Diagnostic -> Si hay bloqueo en algun NSG.
next hop -> tracert
Packet capture -> capturar trafico en formato whireshark


04/04/2022
Correo Mónica de la Fuente (Orientaciones laboral) monica.delafuente@pue.es

